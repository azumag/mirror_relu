# テストガイド

このプロジェクトには、単体テストと統合テストが含まれています。

## テストフレームワーク

- **Vitest**: 高速なViteベースのテストフレームワーク
- **@testing-library/react**: Reactコンポーネントのテスト
- **happy-dom**: 軽量なDOMエミュレーション

## テストの実行

```bash
# 全てのテストを実行
npm test

# UIモードでテストを実行
npm run test:ui

# ワンショットモードでテストを実行
npm run test:run

# カバレッジレポートを生成
npm run test:coverage
```

## テストファイル構成

### 単体テスト (Unit Tests)

#### `src/utils/postureDetection.test.ts`
姿勢検出ロジックのテスト
- ✅ 正常な姿勢の検出
- ✅ 猫背の検出（首の角度が155度未満）
- ✅ 画面に近すぎる検出（目の距離が基準の120%以上）
- ✅ 口の開きの検出（開口度が閾値0.02以上）
- ✅ 斜視の検出（目の向きのずれが0.15以上）
- ✅ キャリブレーション距離のデフォルト値処理
- ✅ 全ての必要なメトリクスの返却

**テスト数**: 7個

#### `src/utils/audioAlert.test.ts`
音声アラート管理クラスのテスト
- ✅ 初回アラートの再生許可
- ✅ インターバル内でのアラート抑制
- ✅ インターバル経過後のアラート許可
- ✅ 異なるアラートタイプの独立した管理
- ✅ 有効なアラートタイプの再生
- ✅ 無効なアラートタイプの拒否
- ✅ 音声設定（言語、音量、速度、ピッチ）の適用
- ✅ デフォルト音量の使用
- ✅ 各アラートタイプの正しいメッセージ
- ✅ アラート間隔の変更
- ✅ Web Speech API非対応時のフォールバック処理

**テスト数**: 11個以上

### 統合テスト (Integration Tests)

#### `src/hooks/useCamera.test.ts`
カメラアクセスフックのテスト
- ✅ ローディング状態の初期化
- ✅ カメラの正常な起動と状態更新
- ✅ ビデオ要素へのストリーム設定
- ✅ NotAllowedErrorのハンドリング（権限拒否）
- ✅ NotFoundErrorのハンドリング（カメラ未検出）
- ✅ NotReadableErrorのハンドリング（カメラ使用中）
- ✅ 一般的なDOMExceptionのハンドリング
- ✅ 非DOMExceptionエラーのハンドリング
- ✅ アンマウント時のメディアトラック停止
- ✅ 非同期処理中のクリーンアップ

**テスト数**: 10個

#### `src/hooks/useMediaPipe.test.ts`
MediaPipe統合フックのテスト
- ✅ ローディング状態の初期化
- ✅ MediaPipeの正常な初期化
- ✅ 正しい設定オプションでの初期化
- ✅ 初期化エラーのハンドリング
- ✅ アンマウント時のface landmarkerのクローズ
- ✅ 初期化完了後のクリーンアップ
- ✅ face landmarker未初期化時のnull返却
- ✅ ビデオ要素未提供時のnull返却
- ✅ 顔検出の実行
- ✅ 検出エラーのグレースフルな処理
- ✅ performance.now()の使用確認

**テスト数**: 11個

#### `src/components/CameraView.test.tsx`
メインコンポーネントの統合テスト
- ✅ カメラローディング状態の表示
- ✅ MediaPipeローディング状態の表示
- ✅ カメラエラーの表示
- ✅ MediaPipeエラーの表示
- ✅ 正常読み込み時のカメラビュー表示
- ✅ 検出開始/停止ボタンの切り替え
- ✅ ログパネルの表示/非表示の切り替え
- ✅ キャリブレーション機能
- ✅ ログのクリア機能
- ✅ FPS表示

**テスト数**: 10個以上

## テストカバレッジ

テストカバレッジレポートを生成するには：

```bash
npm run test:coverage
```

カバレッジレポートは以下のディレクトリに生成されます：
- `coverage/` - HTMLレポート

## テストの特徴

### モック (Mocks)
- **Web Speech API**: 音声合成APIのモック
- **MediaDevices API**: カメラアクセスAPIのモック
- **MediaPipe**: AIモデルのモック
- **performance.now()**: タイムスタンプ生成のモック

### 非同期テスト
- `waitFor()`を使用した非同期処理の待機
- Promiseベースの非同期操作のテスト
- クリーンアップ処理のテスト

### エラーハンドリング
- DOMException の各種エラータイプ
- ネットワークエラー
- 初期化エラー
- 実行時エラー

## 既知の問題

一部のテストで以下の警告が表示される場合があります：
- React `act()` 警告: これは非同期の状態更新に関する警告で、機能には影響しません

## テストのベストプラクティス

1. **単体テスト**: 個々の関数やクラスの振る舞いをテスト
2. **統合テスト**: コンポーネントやフックの統合をテスト
3. **モック**: 外部依存をモックして予測可能なテストを作成
4. **エラーケース**: 正常系だけでなくエラー系もテスト
5. **クリーンアップ**: リソースの適切なクリーンアップをテスト

## 今後の改善

- [ ] E2Eテストの追加（Playwright/Cypress）
- [ ] ビジュアルリグレッションテスト
- [ ] パフォーマンステスト
- [ ] アクセシビリティテスト
- [ ] テストカバレッジの向上（目標: 80%以上）
